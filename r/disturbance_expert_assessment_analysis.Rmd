---
title: "Analysis of Disturbance Expert Assessment Surveys"
author: "Heidi Rodenhizer"
date: "`r Sys.Date()`"
output: html_document
---


# Load Packages

```{r}
library(viridis)
library(RColorBrewer)
library(readxl)
library(ggridges)
library(ggforce)
library(ggdensity)
library(DiagrammeR)
library(patchwork)
library(cowplot)
library(grid)
# library(emmeans)
library(tidyverse)
```


# Set Default Theme for Figures

```{r}
theme_set(theme_bw())
```


# Build Frame with all Answers

```{r}
question_frame = expand_grid(
  Category = c('Anthropogenic',
               'Biotic',
               'Fire',
               'Permafrost',
               'Weather'),
  `Whole Question` = c(1, 4),
  Timescale = 'Current',
  Scenario = 'Current'
  ) |>
  rbind(
    expand_grid(
      Category = c('Anthropogenic',
                   'Biotic',
                   'Fire',
                   'Permafrost',
                   'Weather'),
      `Whole Question` = c(2, 3),
      Timescale = c('2100', '2300'),
      Scenario = c('1.5 C', '2 C', 'RCP 8.5')
    )
  ) |>
  mutate(
    Category = factor(Category,
                      levels = c('Anthropogenic',
                                 'Biotic',
                                 'Fire',
                                 'Permafrost',
                                 'Weather')),
    Timescale = factor(
      Timescale,
      levels = c('Current', '2100', '2300')
    ),
    Scenario = factor(
      Scenario,
      levels = c('Current', '1.5 C', '2 C', 'RCP 8.5')
    )
  )

participant_frame = question_frame |>
  full_join(
    tibble(
      x = c(
        paste('Anthropogenic', 1:10, sep = '_'),
        paste('Biotic', 1:13, sep = '_'),
        paste('Fire', c(1:21), sep = '_'),
        paste('Permafrost', 1:22, sep = '_'),
        paste('Weather', 1:11, sep = '_')
      )
    ) |>
      separate_wider_delim(cols = x, 
                           names = c('Category', 'Respondent'),
                           delim = '_') |>
      mutate(
        Category = factor(Category,
                          levels = c('Anthropogenic',
                                     'Biotic',
                                     'Fire',
                                     'Permafrost',
                                     'Weather')),
        Respondent = as.numeric(Respondent)
      ),
    by = c('Category')
  ) |>
  arrange(Category, Respondent, `Whole Question`, Timescale) |>
  mutate(
    Question = case_when(
      `Whole Question` == 1 ~ '1.0',
      `Whole Question` == 2 & Timescale == '2100' ~ '2a',
      `Whole Question` == 2 & Timescale == '2300' ~ '2b',
      `Whole Question` == 3 & Timescale == '2100' ~ '3a',
      `Whole Question` == 3 & Timescale == '2300' ~ '3b',
      `Whole Question` == 4 ~ '4a'
    )
  )

# write_csv(participant_frame,
#           'data/participant_frame.csv')
```


# Load Data

## Participant Key

```{r}
key = read_excel('./data/Expert assessment_participant key.xlsx') |>
  select(-2) |>
  rename(Respondent = Number) |>
  pivot_longer(Anthropogenic:Weather, 
               names_to = 'Category', 
               values_to = 'Name') |>
  filter(!is.na(Name)) |>
  mutate(
    Category = factor(
      Category,
      levels = c(
        'Anthropogenic',
        'Biotic',
        'Fire',
        'Permafrost',
        'Weather'
      )
    )
  ) |>
  arrange(Category, Name)
```

## QA/QC Sheet

```{r}
qa_qc = read_excel('data/QA_QC Notes.xlsx',
                   sheet = 2) |>
  mutate(
    Question = case_when(Question == '1' ~ '1.0',
                                  TRUE ~ Question),
    Category = factor(
      Category,
      levels = c(
        'Anthropogenic',
        'Biotic',
        'Fire',
        'Permafrost',
        'Weather'
      )
    ),
    Scenario = factor(
      Scenario,
      levels = c(
        'Current',
        '1.5 C',
        '2 C',
        'RCP 8.5'
      )
    ),
    Timescale = factor(
      case_when(Timescale == '2020' ~ 'Current',
                TRUE ~ as.character(Timescale)),
      levels = c('Current',
                 '2100',
                 '2300')
    )
  )
```

## Q1/3

```{r}
q1_3 = read_excel(
  './data/Q1_3.xlsx'#, 
  # range = 'A7:K402',
  # col_names = colnames(
  #   read_excel('./data/Q1_3.xlsx', n_max = 1)
  #   )
) |>
  rename_with(~str_to_title(.), .cols = Respondent:Flags) |>
  rename_with(
    ~ str_split(., ' ', simplify = TRUE)[,3], 
    .cols = matches('level')
  ) |>
  rename(`Lower Range` = Lower, `Upper Range` = Upper) |>
  mutate(
    Category = factor(
      Category,
      levels = c(
        'Anthropogenic',
        'Biotic',
        'Fire',
        'Permafrost',
        'Weather'
      )
    ),
    Scenario = factor(
      case_when(
        Scenario == 'Present day' ~ 'Current',
        Scenario == 'A' ~ '1.5 C',
        Scenario == 'B' ~ '2 C',
        Scenario == 'C' ~ 'RCP 8.5'
      ),
      levels = c(
        'Current',
        '1.5 C',
        '2 C',
        'RCP 8.5'
      )
    ),
    Timescale = factor(
      case_when(Timescale == '2020' ~ 'Current',
                TRUE ~ as.character(Timescale)),
      levels = c('Current',
                 '2100',
                 '2300')
      )#,
    # `Upper Range` = case_when(`Upper Range` > 2000 ~ NA,
    #                   TRUE ~ `Upper Range`),
    # `Even Chance` = case_when(`Even Chance` > 2000 ~ NA,
    #                   TRUE ~ `Even Chance`),
    # `Lower Range` = case_when(`Lower Range` > 2000 ~ NA,
    #                   TRUE ~ `Lower Range`)
  ) |>
  rowwise() |>
  # rearrange values that are out of order
  mutate(
    Estimate = median(
      c(as.numeric(`Lower Range`), 
        as.numeric(`Even Chance`), 
        as.numeric(`Upper Range`))
      ),
    Lower = min(
      c(as.numeric(`Lower Range`), 
        as.numeric(`Even Chance`), 
        as.numeric(`Upper Range`))
      ),
    Upper = max(
      c(as.numeric(`Lower Range`), 
        as.numeric(`Even Chance`), 
        as.numeric(`Upper Range`))
      ),
    .after = `Even Chance`
    ) |>
  ungroup() |>
  mutate(
    Estimate = case_when(
      is.na(`Lower Range`) | is.na(`Even Chance`) | is.na(`Upper Range`) ~ as.numeric(`Even Chance`),
      TRUE ~ Estimate
        ),
    Lower = case_when(
      is.na(`Lower Range`) | is.na(`Even Chance`) | is.na(`Upper Range`) ~ as.numeric(`Lower Range`),
      TRUE ~ Lower
        ),
    Upper = case_when(
      is.na(`Lower Range`) | is.na(`Even Chance`) | is.na(`Upper Range`) ~ as.numeric(`Upper Range`),
      TRUE ~ Upper
        ),
    `Whole Question` = as.numeric(str_sub(Question, 1, 1)),
    `Expertise Group` = factor(
      case_when(Expertise <= 3 ~ '3 or Less',
                Expertise >= 4 ~ '4 or More',
                is.na(Expertise) ~ 'Not Provided'),
      levels = c('Not Provided', '3 or Less', '4 or More')
    )
  ) |>
  full_join(participant_frame |>
              filter(`Whole Question` %in% c(1, 3)),
            by = colnames(participant_frame)) |>
  inner_join(key,
            by = c('Category', 'Respondent')) |>
  arrange(Category, Respondent, `Whole Question`, Timescale, Scenario)

nrow(q1_3) == nrow(key)*7 # 1 row for q1, 3 for q3a, and 3 for q3b
```

Add Filtering Column

```{r}
q1_3 = q1_3 |>
  left_join(
    qa_qc,
    by = c('Category', 'Respondent', 'Whole Question', 'Timescale', 'Scenario', 'Question')
  )
```

Long Version

```{r}
q1_3_long = q1_3 |>
  filter(Remove != TRUE | is.na(Remove)) |>
  select(-c(`Lower Range`, `Upper Range`, `Even Chance`)) |>
  pivot_longer(Estimate:Upper, 
               names_to = 'Estimate Type', 
               values_to = 'Carbon Impact') |>
  mutate(
    `Estimate Type` = factor(
      `Estimate Type`,
      levels = c(
        'Lower',
        'Estimate',
        'Upper'
      )
    )
  )
```

Summarized Version

```{r}
se = function(x, na.rm) {
  sd(x, na.rm = na.rm)/n()
}

n_complete = function(x, na.rm) {
  sum(!is.na(x))
}

q1_3_summary = q1_3 |>
  filter(Remove != TRUE | is.na(Remove)) |>
  summarise(
    across(
      .cols = c(
        Estimate, Lower, Upper, Expertise, Confidence
      ),
      .fns = list(
        Mean = mean, Median = median, SD = sd, SE = se, n = n_complete
        ),
      .names = '{.col} {.fn}',
      na.rm = TRUE
    ),
    .by = c(Question, `Whole Question`, Category, Scenario, Timescale)
  ) |>
  mutate(
    `Dodged Timescale 1` = case_when(
      Scenario %in%  c('Current', '2 C') ~ as.numeric(Timescale),
      Scenario == '1.5 C' ~ as.numeric(Timescale) - 0.3,
      Scenario == 'RCP 8.5' ~ as.numeric(Timescale) + 0.3
    ),
    `Dodged Timescale 2` = case_when(
      Scenario %in%  c('Current', '2 C') ~ as.numeric(Category),
      Scenario == '1.5 C' ~ as.numeric(Category) - 0.3,
      Scenario == 'RCP 8.5' ~ as.numeric(Category) + 0.3
    )
  )

# write_csv(
#   q1_3_summary |>
#     select(
#       Category, Timescale, Scenario, Question, `Estimate Mean`, `Lower Mean`, 
#       `Upper Mean`, `Estimate Median`, `Lower Median`, `Upper Median`, 
#       `Estimate SD`, `Lower SD`, `Upper SD`, `Estimate n`, `Lower n`, `Upper n`
#       ) |>
#     mutate(
#       across(
#         `Estimate Mean`:`Upper SD`,
#         ~ round(.x, 2)
#         )
#       ),
#   './tables/q1_3_summary.csv'
# )
```

Q1/3 Notes

```{r}
q1_3_notes = read_excel(
  './data/Q1_3.xlsx',
  sheet = 2
) |>
  inner_join(key,
            by = c('Category', 'Respondent'))
```


## Q2

```{r}
q2 = read_excel('./data/Q2.xlsx') |>
  filter(Respondent != 37 & `QA/QC Completed` == 'yes') |>
  rename_with(~str_to_title(.), .cols = Respondent:Flags) |>
  rename_with(
    ~ str_split(., ' ', simplify = TRUE)[,3], 
    .cols = matches('level')
  ) |>
  mutate(
    across(
      .cols = c(Frequency, Extent, Range, Severity),
      ~ case_when(. == '-' ~ '0',
                  TRUE ~ .) |>
        as.numeric()
    ),
    across(
      .cols = c(Expertise, Confidence),
      ~ as.numeric(.)
      ),
    Scenario = factor(
      case_when(
        Scenario == 'A' ~ '1.5 C',
        Scenario == 'B' ~ '2 C',
        Scenario == 'C' ~ 'RCP 8.5',
        Scenario == 'c' ~ 'RCP 8.5'
      ),
      levels = c(
        '1.5 C',
        '2 C',
        'RCP 8.5'
      )
    ),
    Timescale = factor(
      case_when(Timescale == '2020' ~ 'Current',
                TRUE ~ as.character(Timescale)),
      levels = c('Current',
                 '2100',
                 '2300')
      )
  ) |>
  mutate(`Whole Question` = as.numeric(str_sub(Question, 1, 1)),
         .after = Respondent) |>
  full_join(participant_frame |>
              filter(`Whole Question`== 2),
            by = colnames(participant_frame)) |>
  inner_join(key,
            by = c('Category', 'Respondent')) |>
  arrange(Category, Respondent, `Whole Question`, Timescale, Scenario)

nrow(q2) == nrow(key)*6
```

Add Filtering Column

```{r}
q2 = q2 |>
  full_join(
    qa_qc |>
      filter(`Whole Question` ==2),
    by = c('Category', 'Respondent', 'Whole Question', 'Timescale', 'Scenario', 'Question')
  )
```

Long Version

```{r}
q2_long = q2 |>
  pivot_longer(Frequency:Severity, 
               names_to = 'Variable', 
               values_to = 'Disturbance Change')

q2_long_clean = q2 |>
  filter(Remove != TRUE | is.na(Remove)) |>
  pivot_longer(Frequency:Severity, 
               names_to = 'Variable', 
               values_to = 'Disturbance Change')
```

Summarized Version

```{r}
q2_summary = q2 |>
  filter(Remove != TRUE | is.na(Remove)) |>
  mutate(`Whole Question` = as.numeric(str_sub(Question, 1, 1))) |>
  summarise(
    across(
      .cols = c(
        Frequency, Extent, Range, Severity, Expertise, Confidence
      ),
      ~ mean(., na.rm = TRUE),
      .names = '{.col} Mean'
    ),
    across(
      .cols = c(
        Frequency, Extent, Range, Severity, Expertise, Confidence
      ),
      ~ median(., na.rm = TRUE),
      .names = '{.col} Median'
    ),
    across(
      .cols = c(
        Frequency, Extent, Range, Severity, Expertise, Confidence
      ),
      ~ sd(., na.rm = TRUE),
      .names = '{.col} SD'
    ),
    across(
      .cols = c(
        Frequency, Extent, Range, Severity, Expertise, Confidence
      ),
      ~ sd(., na.rm = TRUE)/n(),
      .names = '{.col} SE'
    ),
    .by = c(Question, `Whole Question`, Category, Scenario, Timescale)
  ) |>
  mutate(
    `Dodged Timescale 1 1` = case_when(
      Scenario %in%  c('Current', '2 C') ~ as.numeric(Timescale),
      Scenario == '1.5 C' ~ as.numeric(Timescale) - 0.3,
      Scenario == 'RCP 8.5' ~ as.numeric(Timescale) + 0.3
    ),
    `Dodged Timescale 2` = case_when(
      Scenario %in%  c('Current', '2 C') ~ as.numeric(Category),
      Scenario == '1.5 C' ~ as.numeric(Category) - 0.3,
      Scenario == 'RCP 8.5' ~ as.numeric(Category) + 0.3
    )
  )
```

```{r}
q2_notes = read_excel(
  './data/Q2.xlsx',
  sheet = 2
) |>
  inner_join(key,
            by = c('Category', 'Respondent'))
```


## Q4

```{r}
q4 = read_excel('./data/Q4_figure.xlsx', 
  range = 'A7:G317',
  col_names = colnames(
    read_excel('./data/Q4_figure.xlsx', range = 'A1:G1')
    )
) |>
  rename(Subquestion = `Sub-question (i-iv)`)  |>
  mutate(
    Aspect = case_when(
      Subquestion == 'i' ~ 'Spatial Variability',
      Subquestion == 'ii' ~ 'Temporal Variability',
      Subquestion == 'iii' ~ 'Direct Effects',
      Subquestion == 'iv' ~ 'Indirect Effects'
    ),
    across(.cols = c(Availability, Consensus),
           ~ (. - 0.5)*2),
    `Whole Question` = as.numeric(str_sub(Question, 1, 1)),
  ) |>
  full_join(participant_frame |>
              filter(`Whole Question`== 4) |>
              select(-c(Timescale, Scenario)) |>
              cross_join(
                tibble(Subquestion = c('i', 'ii', 'iii', 'iv'))
                ),
            by = c('Category', 'Whole Question', 'Respondent', 'Question', 'Subquestion')) |>
  inner_join(key,
            by = c('Category', 'Respondent')) |>
  arrange(Category, Respondent, `Whole Question`, Subquestion) |>
  mutate(
    Quadrant = case_when(
      Availability < 0 & Consensus < 0 ~ 'Speculative',
      Availability < 0 & Consensus > 0 ~ 'Established but Incomplete',
      Availability > 0 & Consensus < 0 ~ 'Competing Explanations',
      Availability > 0 & Consensus > 0 ~ 'Well Established'
    )
  )

nrow(q4) == nrow(key)*4
```

Add Filtering Column

```{r}
q4 = q4 |>
  full_join(
    qa_qc |>
      filter(`Whole Question` == 4) |>
      select(-c(Timescale, Scenario)),
    by = c('Category', 'Respondent', 'Whole Question', 'Question')
  )
```

Summarized Version

```{r}
q4_summary = q4 |>
  filter(Remove != TRUE | is.na(Remove)) |>
  summarise(
    across(
      .cols = Availability:Consensus,
      ~ mean(., na.rm = TRUE),
      .names = '{.col} Mean'
    ),
    across(
      .cols = Availability:Consensus,
      ~ median(., na.rm = TRUE),
      .names = '{.col} Median'
    ),
    across(
      .cols = Availability:Consensus,
      ~ sd(., na.rm = TRUE),
      .names = '{.col} SD'
    ),
    across(
      .cols = Availability:Consensus,
      ~ sd(., na.rm = TRUE)/n(),
      .names = '{.col} SE'
    ),
    .by = c(Question, `Whole Question`, Category, Aspect)
  )
```

```{r}
q4_notes = read_excel(
  './data/Q4_figure.xlsx',
  sheet = 2
)
```

```{r}
q4_notes_summary = q4_notes |>
  summarise(across(
      .cols = Confidence,
      ~ mean(as.numeric(.), na.rm = TRUE),
      .names = '{.col} Mean'
    ),
    across(
      .cols = Confidence,
      ~ median(as.numeric(.), na.rm = TRUE),
      .names = '{.col} Median'
    ),
    .by = c(Category))
```

## Q5

```{r}
q5 = read_excel('data/Q5.xlsx') |>
  rowwise() |>
  mutate(
    `Disturbance Types` = case_when(
      !is.na(`Interacting Disturbance`) ~ str_flatten(
        sort(c(as.character(Category), 
                as.character(`Interacting Disturbance`))), 
        collapse = '/'
      ),
      TRUE ~ NA
    )
  ) |>
  ungroup()

q5 |>
  summarise(count = n(),
            .by = c(`Disturbance Types`)) |>
  arrange(count)

q5 |>
  filter(is.na(Notes)) |>
  summarise(count = n(),
            .by = c(`Disturbance Types`)) |>
  arrange(count)

q5_fp = read_excel('data/Q5.xlsx', sheet = 2)

q5_fp_summary = q5_fp |>
  mutate(
    across(from:to,
           ~ case_when(
             .x == 'Fire Return Interval' ~ 'Fire Return\nInterval',
             TRUE ~ .x)
    ),
    ranking = case_when(
      is.na(ranking) ~ 1,
      ranking == 3 ~ 2,
      ranking == 2 ~ 3,
      ranking == 1 ~ 4)
  ) |>
  summarise(
    ranking = sum(c(ranking, rep(0, 6-n()))),
    relationship = case_when(
      all(is.na(relationship)) ~ NA_character_,
      all(relationship == '-', na.rm = TRUE) ~ '-',
      all(relationship == '+', na.rm = TRUE) ~ '+',
      all(relationship == '-' | relationship == '+/-', na.rm = TRUE) ~ '-',
      all(relationship == '+' | relationship == '+/-', na.rm = TRUE) ~ '+',
      TRUE ~ '+/-'
    ),
    causation = case_when(
      all(causation == 'yes', na.rm = TRUE) ~ 'solid',
      all(causation == 'no', na.rm = TRUE) ~ 'dotted',
      TRUE ~ 'solid'
    ),
    count = n(),
    .by = c('from', 'to')
  )

q5_fw = read_excel('data/Q5.xlsx', sheet = 3)

q5_fw_summary = q5_fw |>
  mutate(
    across(from:to,
           ~ case_when(
             .x == 'Winter Soil Temperature' ~ 'Winter Soil\nTemperature',
             .x == 'Summer Soil Temperature' ~ 'Summer Soil\nTemperature',
             .x == 'Permafrost Thaw/ALT' ~ 'Permafrost\nThaw/ALT',
             .x == 'Vegetation Mortality' ~ 'Vegetation\nMortality',
             TRUE ~ .x)
    ),
    ranking = case_when(
      is.na(ranking) ~ 1,
      ranking == 3 ~ 2,
      ranking == 2 ~ 3,
      ranking == 1 ~ 4)
  ) |>
  summarise(
    ranking = sum(c(ranking, rep(0, 6-n()))),
    relationship = case_when(
      all(is.na(relationship)) ~ NA_character_,
      all(relationship == '-', na.rm = TRUE) ~ '-',
      all(relationship == '+', na.rm = TRUE) ~ '+',
      TRUE ~ '+/-'
    ),
    causation = case_when(
      all(causation == 'yes', na.rm = TRUE) ~ 'solid',
      all(causation == 'no', na.rm = TRUE) ~ 'dotted',
      TRUE ~ 'solid'
    ),
    count = n(),
    .by = c('from', 'to')
  )
```

## Demographic Information

```{r}
mean_from_string = function(string, delim) {
  if(!is.na(string)) {
    new_value = string |>
      str_split_1(delim) |>
      as.numeric() |>
      mean(na.rm = TRUE)
  } else {
    new_value = NA_real_
  }
  
  return(new_value)
} 

research_approaches = c('Field Work', 'Remote Sensing', 'Modelling')

demographics = read_excel('data/Demographic Information.xlsx') |>
  mutate(
    across(Gender:`Previous Expert Assessment`, 
           ~ replace_na(.x, 'Not Provided')),
    Category = factor(
      Category,
      levels = c(
        'Anthropogenic',
        'Biotic',
        'Fire',
        'Permafrost',
        'Weather'
      )
    ),
    Gender = case_when(Gender == 'F' ~ 'Female',
                       Gender == 'M' ~ 'Male',
                       Gender == 'Not Provided' ~ 'Not Provided'),
    `Career Stage` = factor(
      case_when(
        str_detect(`Career Stage`, '^(E|e)arly.*(M|m)id$') ~ 'Mid',
        str_detect(`Career Stage`, '^(M|m)id.*(E|e)stablished$') ~ 'Established',
        str_detect(`Career Stage`, '^Late mid or early established$') ~ 'Established',
        TRUE ~ `Career Stage`
      ),
      levels = c('Early',
                 'Mid',
                 'Established',
                 'Not Provided')
    ),
    Country = case_when(str_detect(Country, 'Switzerland') ~ 'Switzerland',
                        TRUE ~ Country),
    Region = case_when(
      Country %in% c('USA', 'Canada') ~ 'North America',
      Country %in% c('Norway', 'UK', 'Finland', 'Germany', 'Denmark', 'Sweden', 
                     'The Netherlands', 'Switzerland') ~ 'Europe',
      Country %in% c('Australia/USA') ~ 'Oceania',
      Country %in% c('China') ~ 'Asia',
      Country %in% c('Russia') ~ 'Russia',
      Country == 'Not Provided' ~ 'Not Provided'
    )
  ) |>
  rowwise() |>
  mutate(
    across(
      `Field Work`:Other, 
      ~ case_when(
        str_detect(.x, '<|>') ~ as.numeric(str_extract(.x, '\\d+')),
        str_detect(.x, '-') ~ mean_from_string(.x, '-'),
        TRUE ~ as.numeric(.x)
      )
    )
  ) |>
  mutate(
    `Primary Research Approach` = str_flatten(
      research_approaches[
        which(
          c(`Field Work`, `Remote Sensing`, Modelling) == max(c(`Field Work`, `Remote Sensing`, Modelling))
        )
      ],
      collapse = '/'
    ),
    .after = Modelling
  ) |>
  ungroup() |>
  mutate(
    `Primary Research Approach` = case_when(
      `Primary Research Approach` == '' ~ 'Not Provided',
      TRUE ~ `Primary Research Approach`
    )
  )
```

```{r}
demographics_long = demographics |>
  pivot_longer(c(`Field Work`:Modelling, Other),
               names_to = 'Task',
               values_to = 'Time') |>
  mutate(Task = factor(Task,
                       levels = c('Field Work',
                                  'Modelling',
                                  'Remote Sensing',
                                  'Other')),
         `Other Type` = case_when(Task == 'Other' ~ `Other Type`,
                                  TRUE ~ NA)) 
```

```{r}
demographics_summary = demographics_long |>
  summarise(`Time Mean` = mean(Time, na.rm = TRUE),
            `Time SD` = sd(Time, na.rm = TRUE),
            .by = c(Task, Category))

demographics_summary = demographics_summary |>
  rbind(
    demographics_long |>
      summarise(`Time Mean` = mean(Time, na.rm = TRUE),
                `Time SD` = sd(Time, na.rm = TRUE),
                .by = c(Task)) |>
      mutate(Category = factor('All Categories',
                               levels = c('Anthropogenic',
                                          'Biotic',
                                          'Fire',
                                          'Permafrost',
                                          'Weather',
                                          'All Categories')))
  )
```

```{r}
demographics_long = demographics_long |>
  rbind(demographics_long |>
          mutate(Category = factor('All Categories',
                                   levels = c('Anthropogenic',
                                              'Biotic',
                                              'Fire',
                                              'Permafrost',
                                              'Weather',
                                              'All Categories')))
        )
```


# Completion Rates

```{r}
completion_frame = expand_grid(
  Category = c('Anthropogenic',
               'Biotic',
               'Fire',
               'Permafrost',
               'Weather'),
  `Whole Question` = c(1, 4),
  Timescale = 'Current',
  Completion = c('Missing', 'Partial', 'Complete')
) |>
  rbind(
    expand_grid(
      Category = c('Anthropogenic',
                   'Biotic',
                   'Fire',
                   'Permafrost',
                   'Weather'),
      `Whole Question` = c(2, 3),
      Timescale = c('2100', '2300'),
      Completion = c('Missing', 'Partial', 'Complete')
    )
  ) |>
  mutate(
    Timescale = factor(
      Timescale,
      levels = c('Current', '2100', '2300')
    ),
    Completion = factor(
      Completion,
      levels = c('Missing', 'Partial', 'Complete')
    )
  )

respondents = q1_3 |>
  summarise(
    Completion = factor(
      case_when(
        all(!is.na(Lower)) & all(!is.na(Upper)) & all(!is.na(Estimate)) ~ 'Complete',
        any(!is.na(Lower)) | any(!is.na(Upper)) | any(!is.na(Estimate)) ~ 'Partial',
        all(is.na(Lower)) & all(is.na(Upper)) & all(is.na(Estimate)) ~ 'Missing'
      ),
      levels = c('Missing', 'Partial', 'Complete')
    ),
    .by = c(Respondent, Category, `Whole Question`, Timescale)
  ) |>
  rbind(
    q2_long |>
      summarise(
        Completion = factor(
          case_when(
            all(!is.na(`Disturbance Change`)) ~ 'Complete',
            any(!is.na(`Disturbance Change`)) ~ 'Partial',
            all(is.na(`Disturbance Change`)) ~ 'Missing'
          ),
          levels = c('Missing', 'Partial', 'Complete')
        ),
        .by = c(Respondent, Category, `Whole Question`, Timescale)
      )
  ) |>
  rbind(
    q4 |>
      summarise(
        Completion = factor(
          case_when(
            all(!is.na(Consensus)) & all(!is.na(Availability)) ~ 'Complete',
            any(!is.na(Consensus)) | any(!is.na(Availability)) ~ 'Partial',
            all(is.na(Consensus)) & all(is.na(Availability)) ~ 'Missing'
          ),
          levels = c('Missing', 'Partial', 'Complete')
        ),
        .by = c(Respondent, Category, `Whole Question`)
      ) |>
      mutate(Timescale = 'Current',
             .before = Completion)
  ) |>
  summarise(Count = n(),
            .by = c(Category, `Whole Question`, Timescale, Completion)) |>
  full_join(
    completion_frame, 
    by = c('Category', 'Whole Question', 'Timescale', 'Completion')
    ) |>
  mutate(Count = case_when(is.na(Count) ~ 0,
                           TRUE ~ Count)) |>
  arrange(Category, `Whole Question`, Timescale)
```


# Figures

```{r}
scenario_colors = c('gray30','#FFCC00', '#FF6600', '#990000')
```


## Number of Respondents

```{r, fig.height = 6.5, fig.width = 6.5}
ggplot(respondents,
       aes(x = Timescale, 
           y = Count, 
           color = Completion, 
           fill = Completion)) +
  geom_bar(width = 0.46, position = position_dodge(width = 0.5),
           stat = 'identity') +
  scale_color_viridis(discrete = TRUE,
                     direction = -1,
                     option = 'inferno',
                     begin = 0.1,
                     end = 0.9) +
  scale_fill_viridis(discrete = TRUE,
                     direction = -1,
                     option = 'inferno',
                     begin = 0.1,
                     end = 0.9) +
  scale_x_discrete(name = 'Question') +
  scale_y_continuous(name = 'Number of Respondents') +
  facet_grid(Category ~ `Whole Question`, scales = 'free_x') +
  theme(legend.position = 'bottom')

# ggsave('./figures/respondent_count.pdf',
#        height = 6.5, width = 6.5)
# ggsave('./figures/respondent_count.jpg',
#        height = 6.5, width = 6.5)
```


## Expertise

```{r}
expertise = rbind(
    q1_3 |>
      select(Respondent,
             Question,
             `Whole Question`, 
             Category, 
             Timescale, 
             Expertise),
    q2 |>
      select(Respondent,
             Question,
             `Whole Question`, 
             Category, 
             Timescale, 
             Expertise)
) |>
  distinct() |>
  mutate(Question = case_when(Question == '1.0' ~ '1',
                              TRUE ~ Question))

expertise_summary = expertise |>
  summarise(`Expertise Mean` = mean(Expertise, na.rm = TRUE),
            `Expertise Median` = median(Expertise, na.rm = TRUE),
            .by = c(Question, `Whole Question`, Category, Timescale))
```

```{r, fig.height = 6.5, fig.width = 6.5}
ggplot(expertise,
       aes(x = Expertise,
           fill = Timescale)
) +
  geom_bar(
    position = position_dodge(width = 0.75)
  ) +
  geom_vline(data = expertise_summary,
             aes(xintercept = `Expertise Mean`,
                 linetype = 'Mean')) +
  geom_vline(data = expertise_summary,
             aes(xintercept = `Expertise Median`,
                 linetype = 'Median')) +
  scale_fill_viridis(discrete = TRUE) +
  scale_linetype_manual(values = c('solid', 'dashed'),
                        guide = guide_legend(title = element_blank())) +
  scale_x_continuous(limits = c(1, 5)) +
  scale_y_continuous(name = 'Number of Respondents',
                     breaks = seq(0, 12, by = 2)) +
  facet_grid(Category ~ Question, scales = 'free_x')

# ggsave('./figures/demographics_expertise.pdf',
#        height = 6.5,
#        width = 6.5)
# ggsave('./figures/demographics_expertise.jpg',
#        height = 6.5,
#        width = 6.5)
```


## Q1/Q3

### Violin Plot

```{r, fig.height = 6.5, fig.width = 6.5}
# Median values across respondents
suppressWarnings(
  print(
    ggplot(q1_3 |>
             filter(Remove != TRUE | is.na(Remove)),
           aes(x = Timescale,
               y = Estimate,
               fill = Scenario)) +
      geom_hline(yintercept = 0,
                 color = 'gray30') +
      geom_point(aes(y = Estimate,
                     color = Scenario),
                 position = position_jitterdodge(dodge.width = 0.9,
                                                 jitter.width = 0.7,
                                                 seed = 1),
                 size = 1,
                 alpha = 0.5) +
      geom_segment(aes(y = Lower,
                       yend = Upper,
                       color = Scenario),
                   position = position_jitterdodge(dodge.width = 0.9,
                                                   jitter.width = 0.7,
                                                   seed = 1),
                   width = 0,
                   alpha = 0.5) +
      geom_violin(color = 'gray10',
                  alpha = 0.25,
                  position = position_dodge(width = 0.9)) +
      # scale_color_viridis(name = 'Emissions\nPathway',
      #                     begin = 0.1,
      #                     end = 0.9,
      #                     discrete = TRUE,
      #                     option = 'inferno',
      #                     direction = -1) +
      scale_color_manual(name = 'Emissions Pathway',
                         values = scenario_colors,
                         labels = c("Current",
                                    expression('1.5'*degree*'C'), 
                                    expression('2'*degree*'C'), 
                                    'RCP8.5'),
                         guide = guide_legend(ncol = 2)) +
      scale_fill_manual(name = 'Emissions Pathway',
                        values = scenario_colors,
                        labels = c("Current",
                                    expression('1.5'*degree*'C'), 
                                   expression('2'*degree*'C'), 
                                   'RCP8.5'),
                        guide = guide_legend(ncol = 2)) +
      geom_linerange(data = q1_3_summary,
                     aes(xmin = `Dodged Timescale 1` - 0.1, 
                         xmax = `Dodged Timescale 1` + 0.1,
                         y = `Estimate Median`,
                         linewidth = 'Estimate'),
                     color = 'black') +
      geom_linerange(data = q1_3_summary,
                     aes(xmin = `Dodged Timescale 1` - 0.075, 
                         xmax = `Dodged Timescale 1` + 0.075,
                         y = `Lower Median`,
                         linewidth = 'Lower/Upper'),
                     color = 'black') +
      geom_linerange(data = q1_3_summary,
                     aes(xmin = `Dodged Timescale 1` - 0.075, 
                         xmax = `Dodged Timescale 1` + 0.075,
                         y = `Upper Median`,
                         linewidth = 'Lower/Upper'),
                     color = 'black') +
      scale_linewidth_manual(
        name = 'Median Values',
        values = c(0.7, 0.3),
        # guide = guide_legend(
        #   theme = theme(legend.title = element_blank())
        # )
      ) +
      scale_y_continuous(
        name = expression('TgC yr'^-1),
        transform = "asinh",
        breaks = c(-1000, -100, -10, -1, 0, 1, 10, 100, 1000, 10000),
        # minor_breaks = c(
        #   seq(-4000, -1000, by = 1000),
        #   seq(-900, -100, by = 100),
        #   seq(-90, -10, by = 10),
        #   seq(-9, -1, by = 1),
        #   seq(-0.9, -0.1, by = 0.1),
        #   seq(0.1, 0.9, by = 0.1),
        #   seq(1, 9, by = 1),
        #   seq(10, 90, by = 10),
        #   seq(100, 900, by = 100),
        #   seq(1000, 9000, by = 1000),
        #   seq(10000, 50000, by = 10000)
        # ),
        # labels = function(x) format(x, scientific = TRUE),
        minor_breaks = c(
          -500, -50, -5, -0.5, 0.5, 5, 50, 500, 5000
          ),
        guide = "axis_logticks"
      ) +
      facet_wrap(~ Category, ncol = 2) +
      theme(axis.title.x = element_blank(),
            axis.text.x = element_text(angle = 45, hjust = 1),
            legend.position = 'inside',
            legend.position.inside = c(0.77, 0.12),
            legend.justification = c(0.5, 0.5))
  )
)

# ggsave('./figures/q1_3_violin.pdf',
#        height = 6.5, width = 6.5)
# ggsave('./figures/q1_3_violin.jpg',
#        height = 6.5, width = 6.5)

suppressWarnings(
  print(
    ggplot(q1_3 |>
             filter(Remove != TRUE | is.na(Remove)),
           aes(x = Timescale,
               y = Estimate,
               fill = Scenario)) +
      geom_hline(yintercept = 0,
                 color = 'gray30') +
      geom_point(aes(y = Estimate,
                     color = Scenario),
                 position = position_jitterdodge(dodge.width = 0.9,
                                                 jitter.width = 0.7,
                                                 seed = 1),
                 size = 1,
                 alpha = 0.5) +
      geom_segment(aes(y = Lower,
                       yend = Upper,
                       color = Scenario),
                   position = position_jitterdodge(dodge.width = 0.9,
                                                   jitter.width = 0.7,
                                                   seed = 1),
                   width = 0,
                   alpha = 0.5) +
      geom_violin(color = 'gray10',
                  alpha = 0.25,
                  position = position_dodge(width = 0.9)) +
      # scale_color_viridis(name = 'Emissions\nPathway',
      #                     begin = 0.1,
      #                     end = 0.9,
      #                     discrete = TRUE,
      #                     option = 'inferno',
      #                     direction = -1) +
      scale_color_manual(name = 'Emissions Pathway',
                         values = scenario_colors,
                         guide = guide_legend(ncol = 2)) +
      scale_fill_manual(name = 'Emissions Pathway',
                        values = scenario_colors,
                        guide = guide_legend(ncol = 2)) +
      geom_linerange(data = q1_3_summary,
                     aes(xmin = `Dodged Timescale 1` - 0.1, 
                         xmax = `Dodged Timescale 1` + 0.1,
                         y = `Estimate Median`,
                         linewidth = 'Estimate'),
                     color = 'black') +
      geom_linerange(data = q1_3_summary,
                     aes(xmin = `Dodged Timescale 1` - 0.075, 
                         xmax = `Dodged Timescale 1` + 0.075,
                         y = `Lower Median`,
                         linewidth = 'Lower/Upper'),
                     color = 'black') +
      geom_linerange(data = q1_3_summary,
                     aes(xmin = `Dodged Timescale 1` - 0.075, 
                         xmax = `Dodged Timescale 1` + 0.075,
                         y = `Upper Median`,
                         linewidth = 'Lower/Upper'),
                     color = 'black') +
      scale_linewidth_manual(
        name = 'Median Values',
        values = c(0.7, 0.3),
        # guide = guide_legend(
        #   theme = theme(legend.title = element_blank())
        # )
      ) +
      scale_y_continuous(
        name = expression('TgC yr'^-1)
        ) +
      facet_wrap(~ Category, ncol = 2, scales = 'free_y') +
      theme(axis.title.x = element_blank(),
            axis.text.x = element_text(angle = 45, hjust = 1),
            legend.position = 'inside',
            legend.position.inside = c(0.75, 0.12),
            legend.justification = c(0.5, 0.5))
  )
)
```

```{r, fig.height = 6.5, fig.width = 6.5}
ggplot(q1_3 |>
       filter(Remove != TRUE | is.na(Remove)), 
       aes(x = Category,
           y = Estimate,
           fill = Scenario)) +
  geom_hline(yintercept = 0,
             color = 'gray30') +
  geom_point(aes(y = Estimate,
                 color = Scenario),
             position = position_jitterdodge(dodge.width = 0.9,
                                             jitter.width = 0.7,
                                             seed = 1),
             size = 1,
             alpha = 0.5) +
  geom_segment(aes(y = Lower,
                   yend = Upper,
                   color = Scenario),
             position = position_jitterdodge(dodge.width = 0.9,
                                             jitter.width = 0.7,
                                             seed = 1),
             width = 0,
             alpha = 0.5) +
  geom_violin(color = 'gray10',
              alpha = 0.25,
              position = position_dodge(width = 0.9)) +
  # scale_color_viridis(name = 'Emissions\nPathway',
  #                     begin = 0.1,
  #                     end = 0.9,
  #                     discrete = TRUE,
  #                     option = 'inferno',
  #                     direction = -1) +
  scale_color_manual(
    name = 'Emissions\nPathway',
    values = scenario_colors#,
    # guide = guide_legend(ncol = 2)
  ) +
  scale_fill_manual(
    name = 'Emissions\nPathway',
    values = scenario_colors#,
    # guide = guide_legend(ncol = 2)
  ) +
  geom_linerange(data = q1_3_summary,
                 aes(xmin = `Dodged Timescale 2` - 0.1, 
                     xmax = `Dodged Timescale 2` + 0.1,
                     y = `Estimate Median`,
                     linewidth = 'Estimate'),
                 color = 'black') +
  geom_linerange(data = q1_3_summary,
                 aes(xmin = `Dodged Timescale 2` - 0.075, 
                     xmax = `Dodged Timescale 2` + 0.075,
                     y = `Lower Median`,
                     linewidth = 'Lower/Upper'),
                 color = 'black') +
  geom_linerange(data = q1_3_summary,
                 aes(xmin = `Dodged Timescale 2` - 0.075, 
                     xmax = `Dodged Timescale 2` + 0.075,
                     y = `Upper Median`,
                     linewidth = 'Lower/Upper'),
                 color = 'black') +
  scale_linewidth_manual(
    name = 'Median Values',
    values = c(0.7, 0.3),
    # guide = guide_legend(
    #   theme = theme(legend.title = element_blank())
    # )
  ) +
  scale_y_continuous(
    name = expression('TgC yr'^-1),
    transform = "asinh",
    breaks = c(-1000, -100, -10, -1, 0, 1, 10, 100, 1000, 10000),
    minor_breaks = c(
      seq(-4000, -1000, by = 1000),
      seq(-900, -100, by = 100),
      seq(-90, -10, by = 10),
      seq(-9, -1, by = 1),
      seq(-0.9, -0.1, by = 0.1),
      seq(0.1, 0.9, by = 0.1),
      seq(1, 9, by = 1),
      seq(10, 90, by = 10),
      seq(100, 900, by = 100),
      seq(1000, 9000, by = 1000),
      seq(10000, 50000, by = 10000)
    ),
    # labels = function(x) format(x, scientific = TRUE),
    # minor_breaks = c(
    #   -500, -50, -5, -0.5, 0.5, 5, 50, 500, 5000
    #   ),
    guide = "axis_logticks"
  ) +
  facet_wrap(~ Timescale, ncol = 1)# +
  # theme(axis.title.x = element_blank(),
  #       axis.text.x = element_text(angle = 45, hjust = 1),
  #       legend.position = 'inside',
  #       legend.position.inside = c(0.75, 0.13),
  #       legend.justification = c(0.5, 0.5))

# ggsave('./figures/q1_3_violin_categories.pdf',
#        height = 6.5, width = 6.5)
# ggsave('./figures/q1_3_violin_categories.jpg',
#        height = 6.5, width = 6.5)

ggplot(q1_3 |>
       filter(Remove != TRUE | is.na(Remove)), 
       aes(x = Category,
           y = Estimate,
           fill = Scenario)) +
  geom_hline(yintercept = 0,
             color = 'gray30') +
  geom_point(aes(y = Estimate,
                 color = Scenario),
             position = position_jitterdodge(dodge.width = 0.9,
                                             jitter.width = 0.7,
                                             seed = 1),
             size = 1,
             alpha = 0.5) +
  geom_segment(aes(y = Lower,
                   yend = Upper,
                   color = Scenario),
             position = position_jitterdodge(dodge.width = 0.9,
                                             jitter.width = 0.7,
                                             seed = 1),
             width = 0,
             alpha = 0.5) +
  geom_violin(color = 'gray10',
              alpha = 0.25,
              position = position_dodge(width = 0.9)) +
  # scale_color_viridis(name = 'Emissions\nPathway',
  #                     begin = 0.1,
  #                     end = 0.9,
  #                     discrete = TRUE,
  #                     option = 'inferno',
  #                     direction = -1) +
  scale_color_manual(
    name = 'Emissions\nPathway',
    values = scenario_colors#,
    # guide = guide_legend(ncol = 2)
  ) +
  scale_fill_manual(
    name = 'Emissions\nPathway',
    values = scenario_colors#,
    # guide = guide_legend(ncol = 2)
  ) +
  geom_linerange(data = q1_3_summary,
                 aes(xmin = `Dodged Timescale 2` - 0.1, 
                     xmax = `Dodged Timescale 2` + 0.1,
                     y = `Estimate Median`,
                     linewidth = 'Estimate'),
                 color = 'black') +
  geom_linerange(data = q1_3_summary,
                 aes(xmin = `Dodged Timescale 2` - 0.075, 
                     xmax = `Dodged Timescale 2` + 0.075,
                     y = `Lower Median`,
                     linewidth = 'Lower/Upper'),
                 color = 'black') +
  geom_linerange(data = q1_3_summary,
                 aes(xmin = `Dodged Timescale 2` - 0.075, 
                     xmax = `Dodged Timescale 2` + 0.075,
                     y = `Upper Median`,
                     linewidth = 'Lower/Upper'),
                 color = 'black') +
  scale_linewidth_manual(
    name = 'Median Values',
    values = c(0.7, 0.3),
    # guide = guide_legend(
    #   theme = theme(legend.title = element_blank())
    # )
  ) +
  scale_y_continuous(
    name = expression('TgC yr'^-1),
    # transform = "asinh",
    # breaks = c(-1000, -100, -10, -1, 0, 1, 10, 100, 1000, 10000),
    # minor_breaks = c(
    #   seq(-4000, -1000, by = 1000),
    #   seq(-900, -100, by = 100),
    #   seq(-90, -10, by = 10),
    #   seq(-9, -1, by = 1),
    #   seq(-0.9, -0.1, by = 0.1),
    #   seq(0.1, 0.9, by = 0.1),
    #   seq(1, 9, by = 1),
    #   seq(10, 90, by = 10),
    #   seq(100, 900, by = 100),
    #   seq(1000, 9000, by = 1000),
    #   seq(10000, 50000, by = 10000)
    # ),
    # labels = function(x) format(x, scientific = TRUE),
    # minor_breaks = c(
    #   -500, -50, -5, -0.5, 0.5, 5, 50, 500, 5000
    #   ),
    # guide = "axis_logticks"
  ) +
  facet_wrap(~ Timescale, ncol = 1, scales = 'free')# +
  # theme(axis.title.x = element_blank(),
  #       axis.text.x = element_text(angle = 45, hjust = 1),
  #       legend.position = 'inside',
  #       legend.position.inside = c(0.75, 0.13),
  #       legend.justification = c(0.5, 0.5))

```

By Expertise

```{r}
ggplot(q1_3 |>
         filter(
           `Whole Question` == 1
         ),
       aes(x = Estimate, y = `Expertise Group`)) +
  geom_density_ridges() +
  facet_wrap(~ Category)

ggplot(q1_3 |>
         filter(
           `Whole Question` == 3 & Timescale == '2100'
         ),
       aes(x = Estimate, y = `Expertise Group`,
           fill = Scenario)) +
  geom_density_ridges(alpha = 0.5) +
  scale_fill_manual(name = 'Emissions\nPathway',
                     values = scenario_colors[2:4]) +
  facet_wrap(~ Category, scales = 'free')

ggplot(q1_3 |>
         filter(
           `Whole Question` == 3 & Timescale == '2300'
         ),
       aes(x = Estimate, y = `Expertise Group`,
           fill = Scenario)) +
  geom_density_ridges(alpha = 0.5) +
  scale_fill_manual(name = 'Emissions\nPathway',
                     values = scenario_colors[2:4]) +
  facet_wrap(~ Category, scales = 'free')
```


### Summarized Values
Even chance values which fall outside of Lower-Upper range, could be due to some people not filling in all boxes?

```{r}
# Mean values across respondents
ggplot(q1_3_summary, 
       aes(x = Timescale,
           color = Scenario)) +
  geom_hline(yintercept = 0,
             color = 'gray30') +
  geom_point(aes(y = `Lower Mean`),
             position = position_dodge(width = 0.75),
             size = 2,
             alpha = 0.5) +
  geom_errorbar(aes(ymin = `Lower Mean` - `Lower SD`,
                    ymax = `Lower Mean` + `Lower SD`),
             position = position_dodge(width = 0.75),
             width = 0.25,
             alpha = 0.5) +
  geom_point(aes(y = `Estimate Mean`),
             position = position_dodge(width = 0.75),
             size = 3) +
  geom_errorbar(aes(ymin = `Estimate Mean` - `Estimate SD`,
                    ymax = `Estimate Mean` + `Estimate SD`),
             position = position_dodge(width = 0.75),
             width = 0.5) +
  geom_point(aes(y = `Upper Mean`),
             position = position_dodge(width = 0.75),
             size = 2,
             alpha = 0.5) +
  geom_errorbar(aes(ymin = `Upper Mean` - `Upper SD`,
                    ymax = `Upper Mean` + `Upper SD`),
             position = position_dodge(width = 0.75),
             width = 0.25,
             alpha = 0.5) +
  # scale_color_viridis(name = 'Emissions\nPathway',
  #                     begin = 0.1,
  #                     end = 0.9,
  #                     discrete = TRUE,
  #                     option = 'inferno',
  #                     direction = -1) +
  scale_y_continuous(name = expression('TgC yr'^-1)) +
  scale_color_manual(name = 'Emissions\nPathway',
                     values = scenario_colors) +
  facet_grid(Category ~ ., scales = 'free_y') +
  theme(axis.title.x = element_blank()) +
  ggtitle('Mean Even Chance (bold), Lower, and Upper (lighter) Carbon Impact Across Respondents (Errorbars are Std Dev)')

# Median values across respondents
ggplot(q1_3_summary, 
       aes(x = Timescale,
           color = Scenario)) +
  geom_hline(yintercept = 0,
             color = 'gray30') +
  geom_point(aes(y = `Lower Median`),
             position = position_dodge(width = 0.75),
             size = 2,
             alpha = 0.5) +
  geom_errorbar(aes(ymin = `Lower Median` - `Lower SD`,
                    ymax = `Lower Median` + `Lower SD`),
             position = position_dodge(width = 0.75),
             width = 0.25,
             alpha = 0.5) +
  geom_point(aes(y = `Estimate Median`),
             position = position_dodge(width = 0.75),
             size = 3) +
  geom_errorbar(aes(ymin = `Estimate Median` - `Estimate SD`,
                    ymax = `Estimate Median` + `Estimate SD`),
             position = position_dodge(width = 0.75),
             width = 0.5) +
  geom_point(aes(y = `Upper Median`),
             position = position_dodge(width = 0.75),
             size = 2,
             alpha = 0.5) +
  geom_errorbar(aes(ymin = `Upper Median` - `Upper SD`,
                    ymax = `Upper Median` + `Upper SD`),
             position = position_dodge(width = 0.75),
             width = 0.25,
             alpha = 0.5) +
  # scale_color_viridis(name = 'Emissions\nPathway',
  #                     begin = 0.1,
  #                     end = 0.9,
  #                     discrete = TRUE,
  #                     option = 'inferno',
  #                     direction = -1) +
  scale_y_continuous(name = expression('TgC yr'^-1)) +
  scale_color_manual(name = 'Emissions\nPathway',
                     values = scenario_colors) +
  facet_grid(Category ~ ., scales = 'free_y') +
  theme(axis.title.x = element_blank()) +
  ggtitle('Median Even Chance (bold), Lower, and Upper (lighter) Carbon Impact Across Respondents (Errorbars are Std Dev)')
```

```{r, fig.height = 6.5, fig.width = 6.5}
# all 3 in one plot, but with boxplots
ggplot(q1_3_long, 
       aes(x = Timescale,
           fill = Scenario)) +
  geom_hline(yintercept = 0,
             color = 'gray30') +
  geom_boxplot(aes(y = `Carbon Impact`),
               color = 'black',
               linewidth = 0.25,
               outlier.size = 0.5) +
  # scale_color_viridis(name = 'Emissions\nPathway',
  #                     begin = 0.1,
  #                     end = 0.9,
  #                     discrete = TRUE,
  #                     option = 'inferno',
  #                     direction = -1) +
  scale_y_continuous(name = expression('TgC yr'^-1)) +
  scale_fill_manual(name = 'Emissions\nPathway',
                     values = scenario_colors) +
  facet_grid(Category ~ `Estimate Type`, scales = 'free_y') +
  theme(axis.title.x = element_blank())

# ggsave('./figures/q1_3_overview.pdf',
#        height = 6.5,
#        width = 6.5)
# ggsave('./figures/q1_3_overview.jpg',
#        height = 6.5,
#        width = 6.5)
```

### Q1 Confidence

```{r, fig.height = 6.5, fig.width = 4}
ggplot(q1_3 |>
         filter(Question == '1.0')
) +
  geom_bar(aes(x = Confidence),
           position = position_dodge()) +
  geom_vline(data = q1_3_summary |>
               filter(Question == '1.0'),
             aes(xintercept = `Confidence Mean`,
                 linetype = 'Mean')) +
  geom_vline(data = q1_3_summary |>
               filter(Question == '1.0'),
             aes(xintercept = `Confidence Median`,
                 linetype = 'Median')) +
  scale_linetype_manual(
    values = c('solid', 'dashed'),
    guide = guide_legend(title = element_blank())
  ) +
  scale_x_continuous(limits = c(0.5, 5.5)) +
  scale_y_continuous(name = 'Number of Respondents',
                     breaks = seq(0, 10, by = 2)) +
  facet_grid(Category ~ .)

# ggsave('./figures/q1_confidence.pdf',
#        height = 6.5, 
#        width = 4)
# ggsave('./figures/q1_confidence.jpg',
#        height = 6.5, 
#        width = 4)
```

### Q3 Confidence

```{r, fig.height = 6.5, fig.width = 6.5}
ggplot(
  q1_3 |>
         filter(Question == '3a')
) +
  geom_bar(aes(x = Confidence),
           position = position_dodge()) +
  geom_vline(data = q1_3_summary |>
               filter(Question == '3a'),
             aes(xintercept = `Confidence Mean`,
                 linetype = 'Mean')) +
  geom_vline(data = q1_3_summary |>
               filter(Question == '3a'),
             aes(xintercept = `Confidence Median`,
                 linetype = 'Median')) +
  scale_linetype_manual(
    values = c('solid', 'dashed'),
    guide = guide_legend(title = element_blank())
  ) +
  scale_x_continuous(limits = c(0.5, 5.5)) +
  scale_y_continuous(name = 'Number of Respondents',
                     breaks = seq(0, 10, by = 2)) +
  facet_grid(Category ~ Scenario)

# ggsave('./figures/q3a_confidence.pdf',
#        height = 6.5, 
#        width = 6.5)
# ggsave('./figures/q3a_confidence.jpg',
#        height = 6.5, 
#        width = 6.5)
```

```{r, fig.height = 6.5, fig.width = 6.5}
ggplot(
  q1_3 |>
    filter(Question == '3b')
) +
  geom_bar(aes(x = Confidence),
           position = position_dodge()) +
  geom_vline(data = q1_3_summary |>
               filter(Question == '3b'),
             aes(xintercept = `Confidence Mean`,
                 linetype = 'Mean')) +
  geom_vline(data = q1_3_summary |>
               filter(Question == '3b'),
             aes(xintercept = `Confidence Median`,
                 linetype = 'Median')) +
  scale_linetype_manual(
    values = c('solid', 'dashed'),
    guide = guide_legend(title = element_blank())
  ) +
  scale_x_continuous(limits = c(0.5, 5.5)) +
  scale_y_continuous(name = 'Number of Respondents',
                     breaks = seq(0, 10, by = 2)) +
  facet_grid(Category ~ Scenario)

# ggsave('./figures/q3b_confidence.pdf',
#        height = 6.5, 
#        width = 6.5)
# ggsave('./figures/q3b_confidence.jpg',
#        height = 6.5, 
#        width = 6.5)
```

### Confidence vs. Carbon Impact

```{r}
ggplot(q1_3 |>
         filter(Remove != TRUE | is.na(Remove)), 
       aes(x = Confidence, y = Estimate, color = Scenario)) +
  geom_point() +
  geom_smooth(method = 'lm') +
  facet_grid(Category ~ Timescale)
```


## Q2

### Box Plot

```{r, fig.height = 6.5, fig.width = 6.5}
ggplot(q2_long_clean, 
       aes(x = Timescale, 
           y = `Disturbance Change`, 
           fill = Scenario)) +
  geom_hline(yintercept = 0,
             color = 'gray30') +
  geom_boxplot(position = position_dodge(width = 0.75),
               color = 'black',
               linewidth = 0.25,
               outlier.size = 0.5) +
  scale_fill_manual(
    name = 'Emissions Scenario',
    labels = c(expression('1.5'*degree*'C'), 
               expression('2'*degree*'C'), 
               'RCP8.5'),
    values = scenario_colors[-1]
  ) +
  scale_y_continuous(name = 'Change in Disturbance (%)',
                     breaks = seq(-3, 3),
                     labels = c('<= -50',
                                '-20 - -50',
                                '-5 - -20',
                                '-5 - 5',
                                '5 - 20',
                                '20 - 50',
                                '>= 50')) +
  facet_grid(Category ~ Variable) +
  theme(axis.title.x = element_blank())

ggplot(q2_long_clean, 
       aes(x = Timescale, 
           y = `Disturbance Change`, 
           fill = Scenario)) +
  geom_hline(yintercept = 0,
             color = 'gray30') +
  geom_boxplot(position = position_dodge(width = 0.75),
               color = 'black',
               linewidth = 0.25,
               outlier.size = 0.5) +
  scale_fill_manual(
    name = 'Emissions Scenario',
    labels = c(expression('1.5'*degree*'C'), 
               expression('2'*degree*'C'), 
               'RCP8.5'),
    values = scenario_colors[-1]
  ) +
  scale_y_continuous(name = 'Change in Disturbance (%)',
                     breaks = seq(-3, 3),
                     labels = c('<= -50',
                                '-20 - -50',
                                '-5 - -20',
                                '-5 - 5',
                                '5 - 20',
                                '20 - 50',
                                '>= 50')) +
  facet_grid(Variable ~ Category) +
  theme(axis.title.x = element_blank(),
        panel.spacing.y = unit(0.75, 'lines'),
        legend.position = 'bottom')
  
# ggsave('./figures/q2_overview.pdf',
#        height = 6.5,
#        width = 6.5)
# ggsave('./figures/q2_overview.jpg',
#        height = 6.5,
#        width = 6.5)
```

### Q2 Confidence

```{r, fig.height = 6.5, fig.width = 6.5}
ggplot(
  q2 |>
    filter(Question == '2a')
) +
  geom_bar(aes(x = Confidence),
           position = position_dodge()) +
  geom_vline(data = q2_summary |>
               filter(Question == '2a'),
             aes(xintercept = `Confidence Mean`,
                 linetype = 'Mean')) +
  geom_vline(data = q2_summary |>
               filter(Question == '2a'),
             aes(xintercept = `Confidence Median`,
                 linetype = 'Median')) +
  scale_linetype_manual(
    values = c('solid', 'dashed'),
    guide = guide_legend(title = element_blank())
  ) +
  scale_x_continuous(limits = c(0.5, 5.5)) +
  scale_y_continuous(name = 'Number of Respondents') +
  facet_grid(Category ~ Scenario)

# ggsave('./figures/q2a_confidence.pdf',
#        height = 6.5, 
#        width = 6.5)
# ggsave('./figures/q2a_confidence.jpg',
#        height = 6.5, 
#        width = 6.5)
```

```{r, fig.height = 6.5, fig.width = 6.5}
ggplot(
  q2 |>
    filter(Question == '2b')
) +
  geom_bar(aes(x = Confidence),
           position = position_dodge()) +
  geom_vline(data = q2_summary |>
               filter(Question == '2b'),
             aes(xintercept = `Confidence Mean`,
                 linetype = 'Mean')) +
  geom_vline(data = q2_summary |>
               filter(Question == '2b'),
             aes(xintercept = `Confidence Median`,
                 linetype = 'Median')) +
  scale_linetype_manual(
    values = c('solid', 'dashed'),
    guide = guide_legend(title = element_blank())
  ) +
  scale_y_continuous(name = 'Number of Respondents') +
  facet_grid(Category ~ Scenario)

# ggsave('./figures/q2b_confidence.pdf',
#        height = 6.5, 
#        width = 6.5)
# ggsave('./figures/q2b_confidence.jpg',
#        height = 6.5, 
#        width = 6.5)
```


## Q4

### Scatter Plot

```{r, fig.height = 9, fig.width = 6.5}
ggplot(q4, 
       aes(x = Availability, y = Consensus, color = Aspect, fill = Aspect)) +
  geom_hline(yintercept = 0,
             color = 'gray30') +
  geom_vline(xintercept = 0,
             color = 'gray30') +
  geom_hdr(
    color = 'transparent',
    probs = c(0.8),
    method = 'mvnorm'
    ) +
  scale_alpha_manual(
    values = c(0.1),
    guide = 'none'
    ) +
  # geom_mark_hull(aes(fill = Aspect),
  #                alpha = 0.1,
  #                color = 'transparent',
  #                concavity = 10,
  #                expand = unit(0, "mm"),
  #                radius = unit(0, "mm")) +
  geom_point(
    alpha = 0.5
    ) +
  geom_errorbar(data = q4_summary,
                aes(x = `Availability Mean`,
                    ymin = `Consensus Mean` - `Consensus SD`,
                    ymax = `Consensus Mean` + `Consensus SD`,
                 color = Aspect,
                 width = 0.05),
                inherit.aes = FALSE) +
  geom_errorbarh(data = q4_summary,
                aes(y = `Consensus Mean`,
                    xmin = `Availability Mean` - `Availability SD`,
                    xmax = `Availability Mean` + `Availability SD`,
                 color = Aspect,
                 height = 0.05),
                inherit.aes = FALSE) +
  geom_point(data = q4_summary,
             aes(x = `Availability Mean`,
                 y = `Consensus Mean`,
                 color = Aspect),
             size = 3) +
  geom_text(data = tibble(
    x = c(-0.5, 0.5, -0.5, 0.5),
    y = c(0.95, 0.95, -0.95, -0.95),
    label = c('Established but\nIncomplete', 
              'Well Established', 
              'Speculative', 
              'Competing Explanations'),
    vjust = c(1, 1, 0, 0)
    ),
    aes(x = x, y = y, label = label, vjust = vjust),
    size = 2.5,
    inherit.aes = FALSE
            ) +
  scale_x_continuous(name = 'Availability of Evidence',
                     limits = c(-1, 1),
                     breaks = c(-1, 1),
                     labels = c('Low', 'High')) +
  scale_y_continuous(name = 'Consensus of Evidence',
                     limits = c(-1, 1),
                     breaks = c(-1, 1),
                     labels = c('Low', 'High')) +
  scale_color_viridis(discrete = TRUE,
                      na.translate = FALSE) +
  scale_fill_viridis(discrete = TRUE,
                      na.translate = FALSE) +
  facet_wrap(~ Category, ncol = 2) +
  coord_fixed(expand = FALSE) +
  theme(legend.title = element_blank(),
        legend.position = 'inside',
        legend.position.inside = c(0.75, 0.09),
        legend.justification = c(0.5, 0),
        axis.text.x = element_text(angle = 90, vjust = 0.5))

# ggsave('./figures/q4_compiled.pdf',
#        height = 9,
#        width = 6.5)
# ggsave('./figures/q4_compiled.jpg',
#        height = 9,
#        width = 6.5)
```

```{r}
q4_quadrant_info = q4 |>
  filter(!is.na(Quadrant)) |>
  summarise(n = n(),
            .by = c(Category, Aspect, Quadrant)) |>
  mutate(percent = n/sum(n, na.rm = TRUE),
         .by = c(Category, Aspect)) |>
  arrange(Aspect, Category, -n)

q4_quadrant_info
View(q4_quadrant_info |> filter(n == max(n), .by = c(Category, Aspect)))
```

### Q4 Confidence

```{r, fig.height = 6.5, fig.width = 4}
ggplot(q4_notes
) +
  geom_bar(aes(x = as.numeric(Confidence)),
           position = position_dodge()) +
  geom_vline(data = q4_notes_summary,
             aes(xintercept = `Confidence Mean`,
                 linetype = 'Mean')) +
  geom_vline(data = q4_notes_summary,
             aes(xintercept = `Confidence Median`,
                 linetype = 'Median')) +
  scale_linetype_manual(
    values = c('solid', 'dashed'),
    guide = guide_legend(title = element_blank())
  ) +
  scale_x_continuous(name = 'Confidence',
                     limits = c(0, 5)) +
  scale_y_continuous(name = 'Number of Respondents',
                     breaks = seq(0, 10, by = 2)) +
  facet_grid(Category ~ .)

# ggsave('./figures/q4_confidence.pdf',
#        height = 6.5, 
#        width = 4)
# ggsave('./figures/q4_confidence.jpg',
#        height = 6.5, 
#        width = 4)
```

## Q5

```{r}
nodes = unique(c(q5_fp_summary$from, 
                 q5_fp_summary$to))
nodes_fp = create_node_df(
  n = length(nodes),
  label = nodes,
  x = c(0, 2.5, 3.7, 3.5, 5.3, 7.6, 1.7, 2.7, 4.3, 2, 4.2, 4, 1.5, 1.2, 3.07, 
        5.7, 5, 3.2),
  y = c(2.6, 2, 4.3, 2.6, 2, 2.6, 2.95, 3.2, 1.5, 1.1, 0.8, 0, 0.5, 3.7, 3.63, 
        3, 4, 1.5),
  style = c('filled', rep('rounded', 4), 'filled', rep('rounded', 12)),
  color = 'gray50',
  fillcolor = c('gray70', rep('white', 4), 'gray70', rep('white', 12)),
  shape = c('rectangle', rep('rectangle', 4), 'rectangle', rep('rectangle', 12)),
  fontcolor = 'black',
  height = 0.1,
  width = 0.3,
  fixedsize = FALSE
)
nodes_fp

nodes_fp_filter = nodes_fp |>
  filter(!label %in% c('Precipitation', 'Short-Lived Climate Forcers'))

edges_fp = create_edge_df(
  from = q5_fp_summary|>
    select(from) |>
    rename(label = from) |>
    left_join(nodes_fp, by = 'label') |>
    pull(id),
  to = q5_fp_summary|>
    select(to) |>
    rename(label = to) |>
    left_join(nodes_fp, by = 'label') |>
    pull(id),
  # label = q5_fp_summary$count,
  fontsize = 10,
  # color = gray(((q5_fp_summary$count/(max(q5_fp_summary$count)*2)+0.25)*-1)+1),
  # color = 'gray50',
  color = case_when(q5_fp_summary$relationship == '+' ~ '#CC6666',
                    q5_fp_summary$relationship == '+/-' ~ 'gray50',
                    q5_fp_summary$relationship == '-' ~ '#6699CC'),
  penwidth = q5_fp_summary$ranking/1.5,
  style = q5_fp_summary$causation
)
edges_fp

edges_fp_filter = edges_fp |>
  filter(style != 'dotted')

fp = create_graph()
fp = fp %>%
  add_nodes_from_table(table = nodes_fp_filter,
                       label_col = label) %>%
  add_edges_from_table(table = edges_fp_filter,
                       from_col = from,
                       to_col = to,
                       from_to_map = id_external)

render_graph(fp)
# export_graph(fp,
#              './figures/q5_fire_permafrost_network_diagram_color.pdf',
#              height = 1062,
#              width = 1950)

q5_legend = get_legend(
  ggplot() +
    geom_segment(
      aes(
        x = c(0, 1, 2),
        y = c(0, 0, 0),
        xend = c(1, 2, 3),
        yend = c(1, 1, 1),
        color = factor(
          c("Positive", "Negative", "Uncertain"),
          levels = c("Positive", "Negative", "Uncertain")
        )
      ),
      arrow = arrow(
        length = unit(4, "pt"),
        type = "closed"
        )
    ) +
    geom_segment(
      aes(
        x = c(0, 1, 2),
        y = c(0, 0, 0),
        xend = c(1, 2, 3),
        yend = c(1, 1, 1),
        color = factor(
          c("Positive", "Negative", "Uncertain"),
          levels = c("Positive", "Negative", "Uncertain")
        ),
        linewidth =  factor(
          c("Lower", "Lower", "Higher"),
          levels = c("Lower", "Higher")
        )
      )
    ) +
    scale_color_manual(
      name = "Relationship\nSign",
      values = c("#CC6666", "#6699CC", "gray50")
    ) +
    scale_linewidth_manual(
      name = "Relationship\nImportance",
      values = c(0.25, 2)
    )
)

grid.newpage()
grid.draw(q5_legend)

# ggsave('./figures/q5_fire_permafrost_network_diagram_legend.pdf',
#        q5_legend,
#        height = 2.3,
#        width = 0.9)
```

```{r}
nodes = unique(c(q5_fw_summary$from, 
                 q5_fw_summary$to))
nodes_fw = create_node_df(
  n = length(nodes),
  label = nodes,
  x = c(0, 2, 4.6, 4.2, 6.1, 2, 5.7, 4.5, 6.2, 4.3, 3.7, 1.8, 6.5, 1.2, 1.3, 4.8, 6.2,
        1, 7, 1, 7, 8, 3, 1.4, 3, 1.6),
  y = c(4, 4.5, 4.5, 5.1, 4.3, 6.5, 3.3, 1.7, 1.7, 4, 3.4, 3.6, 6.5, 5.8, 5, 6, 5.5,
        0.7, 0.7, 7, 7, 4, 1, 1.4, 1.9, 2.2),
  style = c('filled', rep('rounded', 20), 'filled', rep('rounded', 4)),
  color = 'gray50',
  fillcolor = c('gray70', rep('white', 20), 'gray70', rep('white', 4)),
  shape = 'rectangle',
  fontcolor = 'black',
  height = 0.1,
  width = 0.3,
  fixedsize = FALSE
)
nodes_fw

edges_fw = create_edge_df(
  from = q5_fw_summary|>
    select(from) |>
    rename(label = from) |>
    left_join(nodes_fw, by = 'label') |>
    pull(id),
  to = q5_fw_summary|>
    select(to) |>
    rename(label = to) |>
    left_join(nodes_fw, by = 'label') |>
    pull(id),
  # label = q5_fw_summary$count,
  fontsize = 10,
  # color = gray(((q5_fw_summary$count/(max(q5_fw_summary$count)*2)+0.25)*-1)+1),
  # color = 'gray50',
  color = case_when(q5_fw_summary$relationship == '+' ~ '#CC6666',
                    q5_fw_summary$relationship == '+/-' ~ 'gray50',
                    q5_fw_summary$relationship == '-' ~ '#6699CC'),
  penwidth = q5_fw_summary$ranking/1.5,
  style = q5_fw_summary$causation
)
edges_fw

fw = create_graph()
fw = fw %>%
  add_nodes_from_table(table = nodes_fw,
                       label_col = label) %>%
  add_edges_from_table(table = edges_fw,
                       from_col = from,
                       to_col = to,
                       from_to_map = id_external)

render_graph(fw)
# export_graph(fw,
#              './figures/q5_fire_weather_network_diagram_color.pdf',
#              height = 1062,
#              width = 1384)
```


## Demographic Information

### Gender

```{r, fig.height = 4, fig.width = 6.5}
gender_count = demographics |>
  summarise(Count = n(),
            .by = c(Gender, Category)) |>
  rbind(demographics |>
          summarise(Count = n(),
                    .by = Gender) |>
          mutate(
            Category = factor('All Categories',
                              levels = c('Anthropogenic',
                                         'Biotic',
                                         'Fire',
                                         'Permafrost',
                                         'Weather',
                                         'All Categories')))
  )

demo_gender = ggplot(gender_count,
       aes(x = Gender, y = Count, fill = Category == 'All Categories')) +
  geom_col() +
  scale_fill_manual(values = c('gray30', 'black')) +
  facet_wrap(~ Category) +
  theme(legend.position = 'none',
        axis.text.x = element_text(angle = 45,
                                   vjust = 1,
                                   hjust = 1))
demo_gender

# ggsave('./figures/demographics_gender.pdf',
#        demo_gender,
#        height = 4,
#        width = 6.5)
# ggsave('./figures/demographics_gender.jpg',
#        demo_gender,
#        height = 4,
#        width = 6.5)
```

### Career Stage

For those people who put themselves in a between category, I rounded up, such that someone who said they were Early/Mid career got classified as Mid career.

```{r, fig.height = 4, fig.width = 6.5}
stage_count = demographics |>
  summarise(Count = n(),
            .by = c(`Career Stage`, Category)) |>
  rbind(demographics |>
          summarise(Count = n(),
                    .by = `Career Stage`) |>
          mutate(
            Category = factor('All Categories',
                              levels = c('Anthropogenic',
                                         'Biotic',
                                         'Fire',
                                         'Permafrost',
                                         'Weather',
                                         'All Categories')))
  ) |>
  mutate(
    provided = case_when(
      `Career Stage` == 'Not Provided' ~ FALSE,
      TRUE ~ TRUE
    )
  ) %>%
  arrange(
    desc(Category), 
    desc(provided), 
    desc(Count), 
    `Career Stage`
  ) %>%
  select(-provided)

demo_stage = ggplot(stage_count,
       aes(x = `Career Stage`, y = Count, fill = Category == 'All Categories')) +
  geom_col() +
  scale_fill_manual(values = c('gray30', 'black')) +
  facet_wrap(~ Category) +
  theme(legend.position = 'none',
        axis.text.x = element_text(angle = 45,
                                   vjust = 1,
                                   hjust = 1))
demo_stage

# ggsave('./figures/demographics_career_stage.pdf',
#        demo_stage,
#        height = 4,
#        width = 6.5)
# ggsave('./figures/demographics_career_stage.jpg',
#        demo_stage,
#        height = 4,
#        width = 6.5)
```

### Country

```{r, fig.height = 6.5, fig.width = 6.5}
country_count = demographics %>%
  summarise(Count = n(),
            .by = c(Country, Category)) %>%
  rbind(demographics %>%
          summarise(Count = n(),
                    .by = Country) %>%
          mutate(
            Category = factor('All Categories',
                              levels = c('Anthropogenic',
                                         'Biotic',
                                         'Fire',
                                         'Permafrost',
                                         'Weather',
                                         'All Categories')))
  ) %>%
  mutate(
    Country = factor(
      Country, 
      levels = c(unique(.$Country)[which(unique(.$Country) != 'Not Provided')],
                 'Not Provided')
    ),
    provided = case_when(
      Country == 'Not Provided' ~ FALSE,
      TRUE ~ TRUE
    )
  ) %>%
  arrange(
    desc(Category), 
    desc(provided), 
    desc(Count), 
    Country
  ) %>%
  select(-provided)

demo_country = ggplot(country_count,
       aes(x = Country, y = Count, fill = Category == 'All Categories')) +
  geom_col() +
  scale_fill_manual(values = c('gray30', 'black')) +
  facet_wrap(~ Category, ncol = 2) +
  theme(legend.position = 'none',
        axis.text.x = element_text(angle = 45,
                                   vjust = 1,
                                   hjust = 1))
demo_country

# ggsave('./figures/demographics_country.pdf',
#        demo_country,
#        height = 6.5,
#        width = 6.5)
# ggsave('./figures/demographics_country.jpg',
#        demo_country,
#        height = 6.5,
#        width = 6.5)
```

### Region

```{r, fig.height = 6.5, fig.width = 6.5}
region_count = demographics %>%
  summarise(Count = n(),
            .by = c(Region, Category)) %>%
  rbind(demographics %>%
          summarise(Count = n(),
                    .by = Region) %>%
          mutate(
            Category = factor('All Categories',
                              levels = c('Anthropogenic',
                                         'Biotic',
                                         'Fire',
                                         'Permafrost',
                                         'Weather',
                                         'All Categories')))
  ) %>%
  mutate(
    Region = factor(
      Region, 
      levels = c(unique(.$Region)[which(unique(.$Region) != 'Not Provided')], 
                 'Not Provided')
    ),
    provided = case_when(
      Region == 'Not Provided' ~ FALSE,
      TRUE ~ TRUE
    )
  ) %>%
  arrange(
    desc(Category), 
    desc(provided), 
    desc(Count), 
    Region
  ) %>%
  select(-provided)

demo_region = ggplot(region_count,
       aes(x = Region, y = Count, fill = Category == 'All Categories')) +
  geom_col() +
  scale_fill_manual(values = c('gray30', 'black')) +
  facet_wrap(~ Category, ncol = 2) +
  theme(legend.position = 'none',
        axis.text.x = element_text(angle = 45,
                                   vjust = 1,
                                   hjust = 1))
demo_region

# ggsave('./figures/demographics_region.pdf',
#        demo_region,
#        height = 6.5,
#        width = 6.5)
# ggsave('./figures/demographics_region.jpg',
#        demo_region,
#        height = 6.5,
#        width = 6.5)
```

### Research Approach

```{r, fig.height = 6.5, fig.width = 6.5}
research_approach_count = demographics %>%
  summarise(Count = n(),
            .by = c(`Primary Research Approach`, Category)) %>%
  rbind(
    demographics %>%
      summarise(Count = n(),
                .by = `Primary Research Approach`) %>%
      mutate(
        Category = factor(
          'All Categories',
          levels = c('Anthropogenic',
                     'Biotic',
                     'Fire',
                     'Permafrost',
                     'Weather',
                     'All Categories')
        )
      )
  ) %>%
  mutate(
    `Primary Research Approach` = factor(
      `Primary Research Approach`, 
      levels = c(
        unique(.$`Primary Research Approach`)[
          which(unique(.$`Primary Research Approach`) != 'Not Provided')
          ], 
        'Not Provided'
        )
    ),
    provided = case_when(
      `Primary Research Approach` == 'Not Provided' ~ FALSE,
      TRUE ~ TRUE
    )
  ) %>%
  arrange(
    desc(Category), 
    desc(provided), 
    desc(Count), 
    `Primary Research Approach`
    ) %>%
  select(-provided)

demo_research_approach = ggplot(research_approach_count,
       aes(x = `Primary Research Approach`, y = Count, fill = Category == 'All Categories')) +
  geom_col() +
  scale_fill_manual(values = c('gray30', 'black')) +
  facet_wrap(~ Category, ncol = 2) +
  theme(legend.position = 'none',
        axis.text.x = element_text(angle = 45,
                                   vjust = 1,
                                   hjust = 1))
demo_research_approach

# ggsave('./figures/demographics_research_approach.pdf',
#        demo_research_approach,
#        height = 6.5,
#        width = 6.5)
# ggsave('./figures/demographics_research_approach.jpg',
#        demo_research_approach,
#        height = 6.5,
#        width = 6.5)
```

### Gender/Stage/Region

```{r}
demo_combo = ((demo_stage + facet_wrap(~ Category, ncol = 6)) / 
                (demo_gender + facet_wrap(~ Category, ncol = 6)) / 
                (demo_region + facet_wrap(~ Category, ncol = 6))) +
  plot_annotation(tag_levels = 'a') &
  # plot_layout(widths = c(1, 1.5)) &
  theme(axis.title = element_text(size = 10),
        axis.text = element_text(size = 8),
        strip.text = element_text(size = 8))
demo_combo

# ggsave('./figures/demographics_combo.pdf',
#        demo_combo,
#        height = 6.5,
#        width = 6.5)
# ggsave('./figures/demographics_combo.jpg',
#        demo_combo,
#        height = 6.5,
#        width = 6.5)
```

### Demographics Table

```{r}
demo_df = stage_count |>
  pivot_wider(names_from = Category, values_from = Count) |>
  rename(Demographic = 1) |>
  mutate(Category = 'Career Stage', .before = Demographic) |>
  bind_rows(
    gender_count |>
      pivot_wider(names_from = Category, values_from = Count) |>
      rename(Demographic = 1) |>
      mutate(Category = 'Gender', .before = Demographic)
  ) |>
  bind_rows(
    region_count |>
      pivot_wider(names_from = Category, values_from = Count) |>
      rename(Demographic = 1) |>
      mutate(Category = 'Region', .before = Demographic)
  ) |>
  bind_rows(
    research_approach_count |>
      pivot_wider(names_from = Category, values_from = Count) |>
      rename(Demographic = 1) |>
      mutate(Category = 'Primary Research Approach', .before = Demographic)
  ) |>
  select(Category, Demographic, Anthropogenic, Biotic, Fire, Permafrost, Weather, `All Categories`)

# write_csv(demo_df,
#           './tables/demographics_summary.csv')
```

### Work Tasks

```{r, fig.height = 5, fig.width = 6.5}
ggplot(demographics_long,
       aes(x = Task, y = Time)) +
  geom_point(alpha = 0.5) +
  geom_point(data = demographics_summary,
             aes(x = Task, y = `Time Mean`),
             inherit.aes = FALSE,
             size = 3) +
  geom_errorbar(data = demographics_summary,
             aes(x = Task, 
                 ymin = `Time Mean` - `Time SD`,
                 ymax = `Time Mean` + `Time SD`),
             inherit.aes = FALSE,
             width = 0.2) +
  facet_wrap(~ Category) +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1,
                                   vjust = 1))

# ggsave('./figures/demographics_tasks.pdf',
#        height = 5, 
#        width = 6.5)
# ggsave('./figures/demographics_tasks.jpg',
#        height = 5, 
#        width = 6.5)
```

### Expertise (self-reported) by Demographics

```{r}
expertise = q1_3 |>
  summarise(Expertise = first(Expertise),
            .by = c(Respondent, Category, Question)) |>
  rbind(
    q2 |>
      summarise(Expertise = first(Expertise),
                .by = c(Respondent, Category, Question))
  ) |>
  summarise(Expertise = mean(Expertise, na.rm = TRUE),
            .by = c(Respondent, Category)) |>
  full_join(demographics,
            by = c('Respondent', 'Category'))

expertise_summary = expertise |>
  summarise(`Expertise Mean` = mean(Expertise, na.rm = TRUE),
            `Expertise SD` = sd(Expertise, na.rm = TRUE),
            .by = c(Gender, `Career Stage`, Category)) |>
  rbind(
    expertise |>
      summarise(`Expertise Mean` = mean(Expertise, na.rm = TRUE),
                `Expertise SD` = sd(Expertise, na.rm = TRUE),
                .by = c(Gender, `Career Stage`)) |>
      mutate(Category = factor('All Categories',
                               levels = c('Anthropogenic',
                                          'Biotic',
                                          'Fire',
                                          'Permafrost',
                                          'Weather',
                                          'All Categories')))
  )

expertise_gender_summary = expertise |>
  summarise(`Expertise Mean` = mean(Expertise, na.rm = TRUE),
            `Expertise SD` = sd(Expertise, na.rm = TRUE),
            .by = c(Gender, Category)) |>
  rbind(
    expertise |>
      summarise(`Expertise Mean` = mean(Expertise, na.rm = TRUE),
                `Expertise SD` = sd(Expertise, na.rm = TRUE),
                .by = c(Gender)) |>
      mutate(Category = factor('All Categories',
                               levels = c('Anthropogenic',
                                          'Biotic',
                                          'Fire',
                                          'Permafrost',
                                          'Weather',
                                          'All Categories')))
  )

expertise_career_summary = expertise |>
  summarise(`Expertise Mean` = mean(Expertise, na.rm = TRUE),
            `Expertise SD` = sd(Expertise, na.rm = TRUE),
            .by = c(`Career Stage`, Category)) |>
  rbind(
    expertise |>
      summarise(`Expertise Mean` = mean(Expertise, na.rm = TRUE),
                `Expertise SD` = sd(Expertise, na.rm = TRUE),
                .by = c(`Career Stage`)) |>
      mutate(Category = factor('All Categories',
                               levels = c('Anthropogenic',
                                          'Biotic',
                                          'Fire',
                                          'Permafrost',
                                          'Weather',
                                          'All Categories')))
  )

expertise = expertise |>
  rbind(expertise |>
          mutate(Category = factor('All Categories',
                                   levels = c('Anthropogenic',
                                              'Biotic',
                                              'Fire',
                                              'Permafrost',
                                              'Weather',
                                              'All Categories'))))
```

Gender/Career Stage

```{r}
expertise_lm_4 = lm(Expertise ~ Gender*`Career Stage`,
   data = expertise)
summary(expertise_lm_4)

expertise_lm_3 = lm(Expertise ~ Gender+`Career Stage`,
   data = expertise)
summary(expertise_lm_3)

expertise_lm_2 = lm(Expertise ~ Gender,
   data = expertise)
summary(expertise_lm_2)

expertise_lm_1 = lm(Expertise ~ `Career Stage`,
   data = expertise)
summary(expertise_lm_1)

expertise_lm_0 = lm(Expertise ~ 1,
   data = expertise)
summary(expertise_lm_0)

AIC(expertise_lm_4, expertise_lm_3, expertise_lm_2, expertise_lm_1, expertise_lm_0)
```

```{r, fig.height = 4, fig.width = 6.5}
ggplot(expertise,
       aes(x = Gender, y = Expertise, color = `Career Stage`)) +
  geom_point(alpha = 0.5) +
  geom_point(data = expertise_gender_summary,
             aes(x = Gender, y = `Expertise Mean`),
             inherit.aes = FALSE,
             size = 3) +
  geom_errorbar(data = expertise_gender_summary,
                aes(x = Gender, 
                    ymin = `Expertise Mean` - `Expertise SD`,
                    ymax = `Expertise Mean` + `Expertise SD`),
                inherit.aes = FALSE,
                width = 0.1) +
  scale_color_viridis(discrete = TRUE) +
  facet_wrap(~ Category) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))

# ggsave('./figures/demographics_expertise_gender.pdf',
#        height = 4, 
#        width = 6.5)
# ggsave('./figures/demographics_expertise_gender.jpg',
#        height = 4, 
#        width = 6.5)

ggplot(expertise,
       aes(x = `Career Stage`, y = Expertise, color = Gender)) +
  geom_point(alpha = 0.5) +
  geom_point(data = expertise_career_summary,
             aes(x = `Career Stage`, y = `Expertise Mean`),
             inherit.aes = FALSE,
             size = 3) +
  geom_errorbar(data = expertise_career_summary,
                aes(x = `Career Stage`, 
                    ymin = `Expertise Mean` - `Expertise SD`,
                    ymax = `Expertise Mean` + `Expertise SD`),
                inherit.aes = FALSE,
                width = 0.1) +
  scale_color_viridis(discrete = TRUE) +
  facet_wrap(~ Category) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))

ggplot(expertise,
       aes(x = Gender, y = Expertise, color = `Career Stage`)) +
  geom_point(alpha = 0.5) +
  geom_point(data = expertise_summary,
             aes(x = Gender, y = `Expertise Mean`),
             inherit.aes = FALSE,
             size = 3) +
  geom_errorbar(data = expertise_summary,
                aes(x = Gender, 
                    ymin = `Expertise Mean` - `Expertise SD`,
                    ymax = `Expertise Mean` + `Expertise SD`),
                inherit.aes = FALSE,
                width = 0.1) +
  scale_color_viridis(discrete = TRUE) +
  facet_grid(Category ~ `Career Stage`) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

### Confidence x Expertise

```{r}
expertise_confidence = q1_3 |>
  select(
    Respondent, Question, Category, Scenario, Timescale, Expertise, Confidence
  ) |>
  bind_rows(
    q2 |>
      select(
        Respondent, Question, Category, Scenario, Timescale, Expertise, Confidence
      )
  ) |>
  mutate(
    Question = case_when(Question == '1.0' ~ '1',
                         TRUE ~ Question),
    Topic = factor(
      case_when(Question == '1' ~ 'Carbon Impact',
                Question == '2a' ~ 'Disturbance (2100)',
                Question == '2b'~ 'Disturbance (2300)',
                Question == '3a' ~ 'Carbon Impact (2100)',
                Question == '3b' ~ 'Carbon Impact (2300)'),
      levels = c(
        'Disturbance (2100)', 
        'Disturbance (2300)',
        'Carbon Impact',
        'Carbon Impact (2100)',
        'Carbon Impact (2300)'
        )
    )
  ) |>
  left_join(demographics, by = c('Respondent', 'Category')) |>
  filter(
    !(is.na(Confidence) | is.na(Expertise) | is.na(Question) | is.na(Category))
    )
```

```{r}
# get_int_slope = function(lm) {
#   
#   # Extract predictors from the model
#   predictors = names(lm$model)[-1]
#   
#   ## categorical predictors
#   cat_predictors = names(lm$xlevels)
#   cat_levels = lm$xlevels
#   cat_levels_count = map(cat_levels, ~ length(.x))
#   cat_count = length(cat_levels)
#   
#   ## numerical predictors
#   numerical_predictors = predictors[
#     which(!predictors %in% categorical_predictors)
#     ]
#   count_numerical = length(numerical_predictors)
#   
#   # Get group combinations
#   if (cat_count >= 1) {
#     
#     group_combos = expand.grid(
#       cat_levels
#     ) |>
#       as_tibble() |>
#       mutate(intercept = NA,
#              slope = NA)
#     
#   } else {
#     
#     group_combos = tibble(intercept = NA, slope = NA)
#     
#   }
#   
#   coef_names = names(coef())
#   
# }
```

```{r}
exp_conf_min_lm = lm(
  Confidence ~ 1,
  data = expertise_confidence
  )

exp_conf_max_lm = lm(
  Confidence ~ Expertise*Question*Category,
  data = expertise_confidence
  )

exp_conf_lm = step(
  exp_conf_max_lm, 
  direction = 'both', 
  scope = list(lower = exp_conf_min_lm, upper = exp_conf_max_lm)
  )
summary(exp_conf_lm)

exp_conf_lm_params = emmeans::emmeans(
  exp_conf_lm,
  ~ Question | Category,
  at = list(Expertise = 0)
  ) |>
  as_tibble() |>
  rename(intercept = emmean) |>
  rename_with(~ paste0('int_', .x),
              .cols = SE:upper.CL) |>
  full_join(
    emmeans::emtrends(
      exp_conf_lm, 
      ~ Question | Category, 
      var = "Expertise"
    ) |>
      as_tibble() |>
      rename(slope = Expertise.trend) |>
      rename_with(~ paste0('slope_', .x),
                  .cols = SE:upper.CL)
  ) |>
  mutate(
    eq_label = paste0(
      'Slope: ',
      round(slope, digits = 2)
      ),
    eq_x = 1,
    eq_y = 4.5,
    Topic = factor(
      case_when(Question == '1' ~ 'Carbon Impact',
                Question == '2a' ~ 'Disturbance (2100)',
                Question == '2b'~ 'Disturbance (2300)',
                Question == '3a' ~ 'Carbon Impact (2100)',
                Question == '3b' ~ 'Carbon Impact (2300)'),
      levels = c(
        'Disturbance (2100)', 
        'Disturbance (2300)',
        'Carbon Impact',
        'Carbon Impact (2100)',
        'Carbon Impact (2300)'
        )
    ),
    Timescale = case_when(Question == '1' ~ 'Current',
                          Question == '2a' ~ '2100',
                          Question == '2b'~ '2300',
                          Question == '3a' ~ '2100',
                          Question == '3b' ~ '2300'),
    Type = case_when(Question == '1' ~ 'Carbon',
                     Question == '2a' ~ 'Disturbance',
                     Question == '2b'~ 'Disturbance',
                     Question == '3a' ~ 'Carbon',
                     Question == '3b' ~ 'Carbon')
  ) |>
  full_join(
    expertise_confidence |>
      summarise(n_answers = n(),
                .by = c(Topic, Category))
  ) |>
  full_join(
    expertise_confidence |>
      summarise(Expertise = first(Expertise),
                .by = c(Topic, Category, Respondent)) |>
      summarise(n_respondents = n(),
                .by = c(Topic, Category))
  )

ggplot(expertise_confidence, aes(x = Expertise, y = Confidence)) +
  geom_point(
    data = expertise_confidence |>
      summarise(Count = n(),
                .by = c(Expertise, Confidence, Category, Topic)),
    aes(x = Expertise, y = Confidence, color = Count),
    inherit.aes = FALSE
  ) +
  # geom_point(aes(color = Gender)) +
  # geom_hex(bins = 30) +
  geom_smooth(method = 'lm', color = 'black') +
  geom_text(
    data = exp_conf_lm_params,
    aes(x = eq_x, y = eq_y, label = eq_label),
    hjust = 0,
    vjust = 0
  ) +
  facet_grid(Category ~ Topic) +
  # scale_color_viridis(discrete = TRUE) +
  # scale_fill_viridis() +
  scale_color_viridis()
```

```{r}
exp_conf_lm_params |>
  summarise(slope_mean = mean(slope, na.rm = TRUE),
            slope_wmean = sum(slope*n_answers)/sum(n_answers),
            n_answers = sum(n_answers),
            n_respondents = sum(n_respondents),
            .by = c(Timescale))

exp_conf_lm_params |>
  summarise(slope_mean = mean(slope, na.rm = TRUE),
            slope_wmean = sum(slope*n_answers)/sum(n_answers),
            n_answers = sum(n_answers),
            n_respondents = sum(n_respondents),
            .by = c(Type))

exp_conf_lm_params |>
  summarise(slope_mean = mean(slope, na.rm = TRUE),
            slope_wmean = sum(slope*n_answers)/sum(n_answers),
            n_answers = sum(n_answers),
            n_respondents = sum(n_respondents),
            .by = c(Timescale, Type))

exp_conf_lm_params |>
  summarise(slope_mean = mean(slope, na.rm = TRUE),
            slope_wmean = sum(slope*n_answers)/sum(n_answers),
            n_answers = sum(n_answers),
            n_respondents = sum(n_respondents),
            .by = c(Category))

```

